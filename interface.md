# 汇编语言与接口技术 “见缝插针”游戏文档  
## 1、 概述
尽管MVC在面向对象编程中更为常见，但用于面向过程编程依然有一定的指导意义。  
所有函数使用cdecl方式定义。   
模型并不负责所有逻辑：界面效果的逻辑由界面负责，游戏的逻辑由模型负责。  
共享的数据结构由我提供。编译时引用sharedVar.inc,并添加sharedVar.asm即可。  
 
## 2、 模型
主要任务：完成程序的核心逻辑，包括控制逻辑和游戏逻辑。
文件名：model.asm/model.inc

### 2、变量  
```x86asm
currWindow db 0  
```
说明：指示当前所在窗口号。0代表主界面，1代表游戏界面，2代表游戏结束界面。  
权限：由模型定义，模型可读可写、视图和控制器只读。  

### 3、函数  
控制器回调函数：在控制器接收到鼠标/键盘事件时会调用此函数。（或者：定时调用？）  
```x86asm
KeyboardEvent proc C type:dword   
```


|Type取值|窗口号|含义|
|------|----|----|
|0|0|开始游戏|
|1|0|退出游戏|
|2|0|静音|
|0|1|发射针（空白区域被点击）|
|1|1|返回主菜单|
|2|1||	
		

**私有函数：（建议实现，但不要求）**   
`InsertPin proc C deg:dword  `  
说明：发射针头，并播放音效。  
实现：在里面加入插入表的逻辑。  

`CheckPin proc C deg:dword  `  
说明：检查角度是否符合要求。如果不符合，则终止游戏，否则插入新的针。  
实现：遍历针表？  
## 3、 视图
文件名：view.asm/view.inc  
### 1、界面概览


各类按钮图标均已在icon文件夹下给出（包括按钮文字）。
实现建议：按钮使用绘图函数、针和圆使用画笔。
### 2、变量与数据结构

上图是对界面渲染的简单描述，为了完成渲染，需要以下数据结构。
**①原始针表pindeg**  
概述：存放每根针的角度的数组，最多存360根。  
定义：pindeg dd 360 DUP(0)。  
**②当前度数currdeg**  
概述：模型和视图共享的变量，只读，由视图通过定时器更新。  
定义：`currdeg dd 0  `  
**③psin表**  
概述：为了避免每次都计算ρ·sin(θ)和ρ·cos(θ)的值，降低计算量，减少函数调用，在启动时一次性计算好对应的数值，后续直接查表即可。  
定义：`psin dd 360 DUP(0)  `  
计算：程序启动时即计算完成。由模型计算。  
**④pcos表**  
概述：同pcos表。  
定义：`pcos dd 360 DUP(0)`  
计算：同③  
刷新方法：  
注意：每次都需要重新绘制整个变动区域。  
针的重绘：  
起点坐标：圆心坐标。  
终点坐标：(cdeg + deg[i]) % 360为当前度数。以这个数为下标查pcos表和psin表。  
原始针表结构：哈希表，开一个大小为360的数组，db类型。元素为0表示  


界面的显示完全由模型控制。界面应该实现以下接口供模型调用：  
#### 1、 得分显示。
`FlushScore proc C num: dword`
说明：刷新记分牌。num：分数。
#### 2、 中心旋转。
`InitCenter proc C data:dword,omega:dword, r:dword ,rou:dword,ptrTb:dword,ptrDg:dword  `
说明：初始化中心旋转的圆。调用该函数后，中心应当出现一个带有1~3根预置针（使用变换针表？）、并且在旋转（使用定时器刷新）的圆。  
data：针的个数。就是显示在最中间的那个数。  
omega：角速度。单位°/s。  
r：中心圆半径。  
rou：弦长度。  
ptrTb：指向原始针表的指针。  
ptrDg：当前度数指针。  

`DeinitCenter proc C  `
说明：销毁旋转的中心。调用后，中心不再旋转，并显示游戏结束界面。  

3、 发射针头。  
4、 计数器？  
`KeyboardEvent proc C type:dword  `





## 4、 控制器
文件名：controller.asm/controller.inc  
作用：处理鼠标和键盘输入，并传送给后端。  
### 1、概述
建议实现方法：利用ACLLIB库的MouseEvent，判断点击区域的坐标来推算点击的是什么按钮。（不优雅但快）    
骚操作（？）：和界面PY一下，用qt，自带事件，写好后封装成lib给汇编调用。  
如果使用ACLLIB库：为了简化编程，建议引入窗口的概念。使用全局变量标识当前窗口。在MouseEvent里用switch判断当前所在窗口，然后执行对应窗口的区域判断逻辑。  
### 2、变量
`currWindow db 0  `
说明：指示当前所在窗口号。0代表主界面，1代表游戏界面，2代表游戏结束界面。  
权限：模型可读可写、视图和控制器只读。  


